name: Build thermal iOS XCFramework

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

jobs:
  build-ios:
    runs-on: macos-latest
    strategy:
      matrix:
        sdk: [iphoneos, iphonesimulator]
        include:
          - sdk: iphoneos
            archs: "arm64"
          - sdk: iphonesimulator
            archs: "arm64;x86_64"
    env:
      DEPLOY_TARGET: "12.0"
      DIST: ${{ github.workspace }}/dist
      OPCV: ${{ github.workspace }}/opencv
      CONTRIB: ${{ github.workspace }}/opencv_contrib
      OCV_VER: "4.12.0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Toolchain
        run: |
          set -euxo pipefail
          brew update
          brew install python@3 cmake ninja

      # --- (속도 개선) OpenCV/opencv_contrib shallow clone 캐시 ---
      - name: Cache OpenCV sources
        id: cache-opencv
        uses: actions/cache@v4
        with:
          path: |
            opencv
            opencv_contrib
          key: opencv-src-${{ env.OCV_VER }}

      - name: Clone OpenCV & contrib (${{ env.OCV_VER }})
        if: steps.cache-opencv.outputs.cache-hit != 'true'
        run: |
          set -euxo pipefail
          git clone --depth=1 -b "${OCV_VER}" https://github.com/opencv/opencv.git "$OPCV"
          git clone --depth=1 -b "${OCV_VER}" https://github.com/opencv/opencv_contrib.git "$CONTRIB"

      # --- SDK별 OpenCV 빌드 ---
      - name: Build OpenCV framework (iphoneos)
        if: matrix.sdk == 'iphoneos'
        run: |
          set -euxo pipefail
          mkdir -p "$DIST/opencv"  # 부모 폴더 보장
          rm -rf "$DIST/opencv/iphoneos" || true
          python3 "$OPCV/platforms/ios/build_framework.py" \
            --build_only_specified_archs \
            --iphoneos_archs "arm64" \
            --iphonesimulator_archs "" \
            --iphoneos_deployment_target "$DEPLOY_TARGET" \
            --without world \
            --contrib "$CONTRIB/modules" \
            --build_list core,imgproc,imgcodecs,ximgproc \
            --cmake_option -DBUILD_SHARED_LIBS=OFF \
            --cmake_option -DBUILD_TESTS=OFF \
            --cmake_option -DBUILD_PERF_TESTS=OFF \
            --cmake_option -DBUILD_EXAMPLES=OFF \
            --cmake_option -DCMAKE_C_FLAGS=-fembed-bitcode \
            --cmake_option -DCMAKE_CXX_FLAGS=-fembed-bitcode \
            "$DIST/opencv/iphoneos"

      - name: Build OpenCV framework (iphonesimulator)
        if: matrix.sdk == 'iphonesimulator'
        run: |
          set -euxo pipefail
          mkdir -p "$DIST/opencv"
          rm -rf "$DIST/opencv/iphonesimulator" || true
          python3 "$OPCV/platforms/ios/build_framework.py" \
            --build_only_specified_archs \
            --iphoneos_archs "" \
            --iphonesimulator_archs "arm64,x86_64" \
            --iphonesimulator_deployment_target "$DEPLOY_TARGET" \
            --without world \
            --contrib "$CONTRIB/modules" \
            --build_list core,imgproc,imgcodecs,ximgproc \
            --cmake_option -DBUILD_SHARED_LIBS=OFF \
            --cmake_option -DBUILD_TESTS=OFF \
            --cmake_option -DBUILD_PERF_TESTS=OFF \
            --cmake_option -DBUILD_EXAMPLES=OFF \
            --cmake_option -DCMAKE_C_FLAGS=-fembed-bitcode \
            --cmake_option -DCMAKE_CXX_FLAGS=-fembed-bitcode \
            "$DIST/opencv/iphonesimulator"

      - name: Debug OpenCV layout (iphonesimulator)
        if: matrix.sdk == 'iphonesimulator'
        run: |
          set -euxo pipefail
          ROOT="$DIST/opencv/iphonesimulator"
          test -d "$ROOT" || (echo "OpenCV output root not found: $ROOT" && exit 1)
          echo "== List OpenCV output (iphonesimulator) =="
          find "$ROOT" -maxdepth 3 -type d -name "opencv2.framework" -print || true
          ls -la "$ROOT" || true

      # --- OpenCV 산출물 탐지 (opencv2.framework 부모 디렉토리를 OPENCV_IOS_ROOT로 export) ---
      - name: Locate opencv2.framework (${{ matrix.sdk }})
        run: |
          set -euxo pipefail
          ROOT="$DIST/opencv/${{ matrix.sdk }}"
          if [ ! -d "$ROOT" ]; then
            echo "OpenCV output root not found: $ROOT"
            ls -la "$DIST/opencv" || true
            exit 1
          fi

          echo "===== Tree of $ROOT ====="
          ls -laR "$ROOT" || true

          # build_framework.py 산출물은 보통 ROOT 또는 ROOT/install 이하에 생성됨
          FW="$(find "$ROOT" -type d -name 'opencv2.framework' | head -n1 || true)"
          if [ -z "$FW" ]; then
            echo "opencv2.framework not found under $ROOT"
            exit 1
          fi

          PARENT_DIR="$(dirname "$FW")"
          echo "Found framework at: $FW"
          echo "Using OPENCV_IOS_ROOT: $PARENT_DIR"
          echo "OPENCV_IOS_ROOT=$PARENT_DIR" >> "$GITHUB_ENV"

      # --- thermal_core (프레임워크 링크 방식) ---
      - name: Clean CMake cache (${{ matrix.sdk }})
        run: |
          rm -rf "build-thermal-${{ matrix.sdk }}" || true

      - name: Configure thermal_core (${{ matrix.sdk }})
        run: |
          cmake -S . -B "build-thermal-${{ matrix.sdk }}" -G Ninja \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=${{ matrix.sdk }} \
            -DCMAKE_OSX_ARCHITECTURES="${{ matrix.archs }}" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET="$DEPLOY_TARGET" \
            -DBUILD_SHARED_LIBS=OFF \
            -DTHERMAL_ENABLE_ANDROID_BRIDGE=OFF \
            -DTHERMAL_ENABLE_CLI=OFF \
            -DOPENCV_IOS_ROOT="$DIST/opencv/${{ matrix.sdk }}/install" \
            -DCMAKE_INSTALL_PREFIX="$DIST/thermal/${{ matrix.sdk }}"

      - name: Build & Install thermal_core (${{ matrix.sdk }})
        run: |
          cmake --build "build-thermal-${{ matrix.sdk }}" --parallel
          cmake --install "build-thermal-${{ matrix.sdk }}"

      # --- 아티팩트 패키징 (SDK별) ---
      - name: Stage artifacts (${{ matrix.sdk }})
        run: |
          set -euxo pipefail
          PKG="$DIST/pack/${{ matrix.sdk }}"
          mkdir -p "$PKG"
          # OpenCV framework
          cp -R "$OPENCV_IOS_ROOT/opencv2.framework" "$PKG/"
          # thermal_core 정적 라이브러리 (설치 산출물 혹은 빌드 산출물 경로 중 존재하는 쪽 사용)
          if [ -f "$DIST/thermal/${{ matrix.sdk }}/lib/libthermal_core.a" ]; then
            cp "$DIST/thermal/${{ matrix.sdk }}/lib/libthermal_core.a" "$PKG/"
          else
            # fallback: 로컬 빌드 산출물
            find "build-thermal-${{ matrix.sdk }}" -name libthermal_core.a -maxdepth 3 | head -n1 | xargs -I{} cp "{}" "$PKG/libthermal_core.a"
          fi
          # 헤더는 레포의 include/thermal 사용
          mkdir -p "$PKG/include"
          cp -R "include/thermal" "$PKG/include/"

      - name: Upload per-SDK artifact (${{ matrix.sdk }})
        uses: actions/upload-artifact@v4
        with:
          name: thermal-ios-${{ matrix.sdk }}
          path: |
            ${{ env.DIST }}/pack/${{ matrix.sdk }}/opencv2.framework
            ${{ env.DIST }}/pack/${{ matrix.sdk }}/libthermal_core.a
            ${{ env.DIST }}/pack/${{ matrix.sdk }}/include

  make-xcframework:
    runs-on: macos-latest
    needs: build-ios

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: thermal-ios-*
          path: dist_in

      - name: Create XCFramework
        run: |
          set -euxo pipefail
          mkdir -p dist_out
          # 공용 헤더 (thermal/*)
          HDRS="dist_in/thermal-ios-iphoneos/include"

          xcodebuild -create-xcframework \
            -library "dist_in/thermal-ios-iphoneos/libthermal_core.a" -headers "$HDRS" \
            -library "dist_in/thermal-ios-iphonesimulator/libthermal_core.a" -headers "$HDRS" \
            -framework "dist_in/thermal-ios-iphoneos/opencv2.framework" \
            -framework "dist_in/thermal-ios-iphonesimulator/opencv2.framework" \
            -output "dist_out/thermal.xcframework"

          (cd dist_out && zip -r thermal.xcframework.zip thermal.xcframework)

      - name: Upload XCFramework
        uses: actions/upload-artifact@v4
        with:
          name: thermal-ios-xcframework
          path: dist_out/thermal.xcframework.zip
