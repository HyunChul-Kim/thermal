name: Build thermal iOS XCFramework

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

jobs:
  build-ios:
    runs-on: macos-latest
    strategy:
      matrix:
        sdk: [iphoneos, iphonesimulator]
        include:
          - sdk: iphoneos
            arch: arm64
          - sdk: iphonesimulator
            arch: "arm64;x86_64"
    env:
      DEPLOY_TARGET: "12.0"
      DIST: ${{ github.workspace }}/dist
      OPCV: ${{ github.workspace }}/opencv
      CONTRIB: ${{ github.workspace }}/opencv_contrib

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone OpenCV & contrib (4.12.0)
        run: |
          git clone --depth=1 -b 4.12.0 https://github.com/opencv/opencv.git "$OPCV"
          git clone --depth=1 -b 4.12.0 https://github.com/opencv/opencv_contrib.git "$CONTRIB"

      - name: Install deps
        run: |
          brew update
          brew install cmake ninja

      # ---------- OpenCV Configure ----------
      - name: Configure OpenCV (${{ matrix.sdk }})
        id: configure-opencv
        run: |
          cmake -S "$OPCV" -B "build-opencv-${{ matrix.sdk }}" -G Ninja \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=${{ matrix.sdk }} \
            -DCMAKE_OSX_ARCHITECTURES="${{ matrix.arch }}" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET="$DEPLOY_TARGET" \
            -DBUILD_SHARED_LIBS=OFF \
            -DBUILD_LIST="core,imgproc,imgcodecs,ximgproc" \
            -DOPENCV_EXTRA_MODULES_PATH="$CONTRIB/modules" \
            -DBUILD_TESTS=OFF -DBUILD_PERF_TESTS=OFF -DBUILD_EXAMPLES=OFF \
            -DWITH_ICONV=OFF -DBUILD_PROTOBUF=ON -DBUILD_ZLIB=ON \
            -DCMAKE_INSTALL_PREFIX="$DIST/opencv/${{ matrix.sdk }}"

      - name: Show OpenCV CMake logs (${{ matrix.sdk }})
        if: always()
        env:
          BUILD_DIR: ${{ github.workspace }}/build-opencv/${{ matrix.sdk }}
        run: |
          echo "===== CMakeError.log (${{ matrix.sdk }}) ====="
          if [[ -f "build-opencv-${{ matrix.sdk }}/CMakeFiles/CMakeError.log" ]]; then
            sed -n '1,200p' "build-opencv-${{ matrix.sdk }}/CMakeFiles/CMakeError.log"
          else
            echo "CMakeError.log not found."
          fi
          echo "===== CMakeOutput.log (${{ matrix.sdk }}) ====="
          if [[ -f "build-opencv-${{ matrix.sdk }}/CMakeFiles/CMakeOutput.log" ]]; then
            tail -n 500 "build-opencv-${{ matrix.sdk }}/CMakeFiles/CMakeOutput.log"
          else
            echo "CMakeOutput.log not found."
          fi

      # ---------- OpenCV Build & Install ----------
      - name: Build OpenCV (${{ matrix.sdk }})
        if: success() && steps.configure-opencv.outcome == 'success'
        run: cmake --build "build-opencv-${{ matrix.sdk }}" --parallel

      - name: Install OpenCV (${{ matrix.sdk }})
        if: success() && steps.configure-opencv.outcome == 'success'
        run: cmake --install "build-opencv-${{ matrix.sdk }}"

      # ---------- thermal_core Configure / Build / Install ----------
      - name: Configure thermal_core (${{ matrix.sdk }})
        id: configure-thermal
        run: |
          cmake -S . -B "build-thermal-${{ matrix.sdk }}" -G Ninja \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=${{ matrix.sdk }} \
            -DCMAKE_OSX_ARCHITECTURES="${{ matrix.arch }}" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET="$DEPLOY_TARGET" \
            -DBUILD_SHARED_LIBS=OFF \
            -DOpenCV_DIR="$DIST/opencv/${{ matrix.sdk }}/lib/cmake/opencv4" \
            -DTHERMAL_ENABLE_ANDROID_BRIDGE=OFF \
            -DTHERMAL_ENABLE_CLI=OFF \
            -DCMAKE_INSTALL_PREFIX="$DIST/thermal/${{ matrix.sdk }}"

      - name: Show thermal_core CMake logs (${{ matrix.sdk }})
        if: always()
        run: |
          echo "===== thermal CMakeError.log (${{ matrix.sdk }}) ====="
          if [[ -f "build-thermal-${{ matrix.sdk }}/CMakeFiles/CMakeError.log" ]]; then
            sed -n '1,200p' "build-thermal-${{ matrix.sdk }}/CMakeFiles/CMakeError.log"
          else
            echo "CMakeError.log not found."
          fi
          echo "===== thermal CMakeOutput.log (${{ matrix.sdk }}) ====="
          if [[ -f "build-thermal-${{ matrix.sdk }}/CMakeFiles/CMakeOutput.log" ]]; then
            tail -n 500 "build-thermal-${{ matrix.sdk }}/CMakeFiles/CMakeOutput.log"
          else
            echo "CMakeOutput.log not found."
          fi

      - name: Build & Install thermal_core (${{ matrix.sdk }})
        run: |
          cmake --build "build-thermal-${{ matrix.sdk }}" --parallel
          cmake --install "build-thermal-${{ matrix.sdk }}"

      # ---------- Merge static libs ----------
      - name: Merge static libs (${{ matrix.sdk }})
        run: |
          set -e
          mkdir -p "$DIST/pack/${{ matrix.sdk }}/include"
          # 복사: 퍼블릭 헤더를 SDK별 아티팩트에 같이 넣자
          rsync -a --delete "include/" "$DIST/pack/${{ matrix.sdk }}/include/"

          OPCV_LIB_DIR="$DIST/opencv/${{ matrix.sdk }}/lib"
          THERMAL_A="$DIST/thermal/${{ matrix.sdk }}/lib/libthermal_core.a"

          # 필수 OpenCV 모듈 + 3rdparty 의존성까지 포함 (있을 때만 추가)
          LIBS=(
            "$THERMAL_A"
            "$OPCV_LIB_DIR/libopencv_core.a"
            "$OPCV_LIB_DIR/libopencv_imgproc.a"
            "$OPCV_LIB_DIR/libopencv_imgcodecs.a"
            "$OPCV_LIB_DIR/libopencv_ximgproc.a"
            "$OPCV_LIB_DIR/liblibjpeg-turbo.a"
            "$OPCV_LIB_DIR/liblibpng.a"
            "$OPCV_LIB_DIR/liblibtiff.a"
            "$OPCV_LIB_DIR/liblibwebp.a"
            "$OPCV_LIB_DIR/libzlib.a"
          )

          # 존재하는 것만 모아 병합
          EXISTING=()
          for f in "${LIBS[@]}"; do
            [[ -f "$f" ]] && EXISTING+=("$f")
          done

          libtool -static -o "$DIST/pack/${{ matrix.sdk }}/libthermal_all.a" "${EXISTING[@]}"

      - name: Upload per-SDK artifact (${{ matrix.sdk }})
        uses: actions/upload-artifact@v4
        with:
          name: thermal-ios-${{ matrix.sdk }}
          path: |
            ${{ env.DIST }}/pack/${{ matrix.sdk }}/libthermal_all.a
            ${{ env.DIST }}/pack/${{ matrix.sdk }}/include

  make-xcframework:
    runs-on: macos-latest
    needs: build-ios
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: thermal-ios-*
          path: dist_in

      - name: Create XCFramework
        run: |
          mkdir -p dist_out
          HDRS="dist_in/thermal-ios-iphoneos/include"
          xcodebuild -create-xcframework \
            -library "dist_in/thermal-ios-iphoneos/libthermal_all.a" -headers "$HDRS" \
            -library "dist_in/thermal-ios-iphonesimulator/libthermal_all.a" -headers "$HDRS" \
            -output "dist_out/thermal.xcframework"
          (cd dist_out && zip -r thermal.xcframework.zip thermal.xcframework)

      - name: Upload XCFramework
        uses: actions/upload-artifact@v4
        with:
          name: thermal-ios-xcframework
          path: dist_out/thermal.xcframework.zip
