name: Build thermal iOS XCFramework

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

jobs:
  build-ios:
    runs-on: macos-latest
    strategy:
      matrix:
        target: [iphoneos, iphonesimulator]
        include:
          - sdk: iphoneos
            arch: arm64
          - sdk: iphonesimulator
            arch: "arm64;x86_64"
    env:
      DEPLOY_TARGET: "12.0"
      DIST: ${{ github.workspace }}/dist
      OPCV: ${{ github.workspace }}/opencv
      CONTRIB: ${{ github.workspace }}/opencv_contrib

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # (B안) 서브모듈 안 쓸 때만 실행: opencv / contrib clone
      - name: Clone OpenCV & contrib (4.12.0)
        run: |
          git clone --depth=1 -b 4.12.0 https://github.com/opencv/opencv.git "$OPCV"
          git clone --depth=1 -b 4.12.0 https://github.com/opencv/opencv_contrib.git "$CONTRIB"

      - name: Install deps
        run: |
          brew update
          brew install cmake ninja

      # (선택) 캐시로 가속하고 싶으면 주석 해제
      # - name: Cache OpenCV build
      #   uses: actions/cache@v4
      #   with:
      #     path: |
      #       build-opencv-${{ matrix.sdk }}
      #       ${{ env.DIST }}/opencv/${{ matrix.sdk }}
      #     key: ${{ runner.os }}-opencv-${{ matrix.sdk }}-${{ hashFiles('opencv/**', 'opencv_contrib/**') }}

      - name: Configure OpenCV (${{ matrix.sdk }})
        id: configure
        run: |
          cmake -S "$OPCV" -B "build-opencv-${{ matrix.sdk }}" -G Ninja \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=${{ matrix.sdk }} \
            -DCMAKE_OSX_ARCHITECTURES="${{ matrix.arch }}" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET="$DEPLOY_TARGET" \
            -DBUILD_SHARED_LIBS=OFF \
            -DBUILD_LIST="core,imgproc,imgcodecs,ximgproc" \
            -DOPENCV_EXTRA_MODULES_PATH="$CONTRIB/modules" \
            -DBUILD_TESTS=OFF -DBUILD_PERF_TESTS=OFF -DBUILD_EXAMPLES=OFF \
            -DWITH_ICONV=OFF -DBUILD_PROTOBUF=ON -DBUILD_ZLIB=ON \
            -DCMAKE_INSTALL_PREFIX="$DIST/opencv/${{ matrix.sdk }}"

      - name: Show CMakeError.log (if configure failed)
        if: failure() && steps.configure.outcome == 'failure'
        run: |
          echo "===== CMakeError.log (${ { matrix.sdk } }) ====="
          if [ -f "$BUILD_DIR/CMakeFiles/CMakeError.log" ]; then
            cat "$BUILD_DIR/CMakeFiles/CMakeError.log"
          else
            echo "CMakeError.log not found."
          fi
          echo "===== CMakeOutput.log (${ { matrix.sdk } }) ====="
          if [ -f "$BUILD_DIR/CMakeFiles/CMakeOutput.log" ]; then
            tail -n +1 "$BUILD_DIR/CMakeFiles/CMakeOutput.log" | tail -n 500
          else
            echo "CMakeOutput.log not found."
          fi

      # ---------------------- BUILD ----------------------------------
      - name: Build OpenCV (${{ matrix.sdk }})
        if: success() && steps.configure.outcome == 'success'
        run: |
          cmake --build "build-opencv-${{ matrix.sdk }}" --parallel

      # ---------------------- INSTALL ----------------------------------
      - name: Install OpenCV (${{ matrix.sdk }})
        if: success() && steps.configure.outcome == 'success'
        run: |
          cmake --install "build-opencv-${{ matrix.sdk }}"
          
      - name: Configure thermal_core (${{ matrix.sdk }})
        run: |
          cmake -S . -B "build-thermal-${{ matrix.sdk }}" -G Ninja \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=${{ matrix.sdk }} \
            -DCMAKE_OSX_ARCHITECTURES="${{ matrix.arch }}" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET="$DEPLOY_TARGET" \
            -DBUILD_SHARED_LIBS=OFF \
            -DOpenCV_DIR="$DIST/opencv/${{ matrix.sdk }}/lib/cmake/opencv4" \
            -DTHERMAL_ENABLE_ANDROID_BRIDGE=OFF \
            -DTHERMAL_ENABLE_CLI=OFF \
            -DCMAKE_INSTALL_PREFIX="$DIST/thermal/${{ matrix.sdk }}"

      - name: Build & Install thermal_core (${{ matrix.sdk }})
        run: |
          cmake --build "build-thermal-${{ matrix.sdk }}" --parallel
          cmake --install "build-thermal-${{ matrix.sdk }}"

      # thermal_core.a + 필요한 opencv .a → 단일 lib로 합침 (소비 측 통합 편의)
      - name: Merge static libs (${{ matrix.sdk }})
        run: |
          mkdir -p "$DIST/pack/${{ matrix.sdk }}"
          OPCV_LIB_DIR="$DIST/opencv/${{ matrix.sdk }}/lib"
          THERMAL_A="$DIST/thermal/${{ matrix.sdk }}/lib/libthermal_core.a"
          libtool -static -o "$DIST/pack/${{ matrix.sdk }}/libthermal_all.a" \
            "$THERMAL_A" \
            "$OPCV_LIB_DIR/libopencv_core.a" \
            "$OPCV_LIB_DIR/libopencv_imgproc.a" \
            "$OPCV_LIB_DIR/libopencv_imgcodecs.a" \
            "$OPCV_LIB_DIR/libopencv_ximgproc.a"

      - name: Upload per-SDK artifact (${{ matrix.sdk }})
        uses: actions/upload-artifact@v4
        with:
          name: thermal-ios-${{ matrix.sdk }}
          path: |
            ${{ env.DIST }}/pack/${{ matrix.sdk }}/libthermal_all.a
            include

  make-xcframework:
    runs-on: macos-latest
    needs: build-ios
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: thermal-ios-*
          path: dist_in

      - name: Create XCFramework
        run: |
          mkdir -p dist_out
          HDRS="dist_in/thermal-ios-iphoneos/include"
          xcodebuild -create-xcframework \
            -library "dist_in/thermal-ios-iphoneos/libthermal_all.a" -headers "$HDRS" \
            -library "dist_in/thermal-ios-iphonesimulator/libthermal_all.a" -headers "$HDRS" \
            -output "dist_out/thermal.xcframework"
          (cd dist_out && zip -r thermal.xcframework.zip thermal.xcframework)

      - name: Upload XCFramework
        uses: actions/upload-artifact@v4
        with:
          name: thermal-ios-xcframework
          path: dist_out/thermal.xcframework.zip
